---
title: 'RQ1 Forest Definition Visualisations'
author: "Nina Moffat"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float:
      collapsed: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Information about visualisations

In this R Markdown script, I create *some* of the visualisations which I plan to include in my thesis. 
For now (for ease and time efficiency) I decided to take the following general strategy with making the visualisations:
- Tables are made directly in word
- Figures like bar charts and plots are made in R (HERE)
- Maps are made in QGIS

If I have time later, I would like to come back to do more visualisations programmatically, but I'll have to see how I get on :)

While I have been using Visual Studio Code for all Python scripts so far, I have used R Studio to create this R Markdown file and simply push my changes in this file (which is contained within the same folder as my other code) to GitHub using the git management features in Visual Studio Code.

```{r install}

# Install pacman for package management
library(pacman)

# Install/load required packages
p_load(tidyverse, 
       scales,
       treemap,
       install = TRUE)

```


## FNF Visualisations

- Create a bar chart of total forest per FNF map with dashed line for mean

```{r fnf_prep}

# Adjust how many digits to display
options(digits=9)

# Read in CSV with adjusted column names
fnf_all <- read_csv("outputs/all_fnf_natura_stats.csv", 
                    col_names = c("index", 
                                  "fnf_map", 
                                  "total_forest_ha",
                                  "total_forest_per",
                                  "diff_mean_ha",
                                  "diff_mean_per"
                                  ),
                    show_col_types = FALSE
                    )

# Tidy-up: remove the first column (index) and first row (old column names)
fnf_all <- fnf_all[2:7,2:6]

# Convert columns to numeric
fnf_all$total_forest_ha <- as.numeric(fnf_all$total_forest_ha)
fnf_all$total_forest_per <- as.numeric(fnf_all$total_forest_per)
fnf_all$diff_mean_ha <- as.numeric(fnf_all$diff_mean_ha)
fnf_all$diff_mean_per <- as.numeric(fnf_all$diff_mean_per)

# Calculate the mean amount of forest (ha) across all FNF maps
fnf_mean_ha <- mean(as.numeric(fnf_all$total_forest_ha))

# Change names of FNF maps to be more space efficient
fnf_all <- fnf_all %>% 
  mutate(fnf_map = str_replace(fnf_map, "Hansen Tree Cover", "Hansen/IGBP")) %>%
  mutate(fnf_map = str_replace(fnf_map, "ESA Land Cover", "ESA")) %>%
  mutate(fnf_map = str_replace(fnf_map, "JAXA Forest/Non-Forest", "JAXA")) %>%
  mutate(fnf_map = str_replace(fnf_map, "CORINE Land Use", "CORINE")) %>%
  mutate(fnf_map = str_replace(fnf_map, "Germany Land Use", "CORINE + LBM-DE")) %>%
  mutate(fnf_map = str_replace(fnf_map, "FAO-Forest Approximation", "FAO")) 

```


Helpful material for ggplot styling:
https://ggplot2.tidyverse.org/articles/faq-axes.html 
https://ggplot2-book.org/themes#sec-themes




```{r fnf_bar}

# Define the order I want the bars in
fnf_order = c("Hansen/IGBP", "ESA", "JAXA",
              "CORINE", "CORINE + LBM-DE", "FAO")

# Create a bar chart of the total forest, with the mean as dashed-line
ggplot(data=fnf_all, aes(x=factor(fnf_map, fnf_order), y=total_forest_ha/1000000)) +
  geom_bar(stat="identity", 
           colour="black", 
           fill="#0F5726",
           width=0.4
           )+
  labs(x="\nForest Definition Operationalisation", 
       y="Total Forest in German Natura 2000 Areas \n(millions ha)\n"
       ) +
  coord_cartesian(ylim=c(3.0, 4.5)) +
  scale_y_continuous(labels = label_number(accuracy = 0.01),
                     breaks = c(3.0, 3.25, 3.5, 3.75, 4.0, 4.25, 4.5),
                     ) +
  geom_hline(yintercept = fnf_mean_ha/1000000, 
             colour = "#676767", 
             linetype = 'dashed'
             ) +
  annotate("text", x=1, y=3.98, 
           label="Mean Forest Area", 
           colour="#676767",
           size = 4,
           hjust = 0,
           family = "serif"
           ) +
  theme(panel.grid.major.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.text = element_text(size=12),
        axis.title = element_text(size=13),
        text = element_text(family="serif")
        )

```
**NOTE**
Some things may look off in the rmd version of the figure - it will look a bit different in the saved png!


```{r fnf_save}

# Once happy with the outputs, save them! 
# Note this will output whatever plot was run last!
ggsave("outputs/figures/fnf_all_bar_chart.png",
       width=9,
       height=5
       )

```


## Forest Consensus Visualisations

- Create a bar chart of total area in each class (see pic in "writing folder")


```{r con_prep}

# Adjust how many digits to display
options(digits=9)

# Read in CSV with adjusted column names
consensus_all <- read_csv("outputs/all_consensus_natura_stats.csv", 
                          col_names = c("index", 
                                        "class", 
                                        "total_area_ha",
                                        "coverage_per"
                                        ),
                          show_col_types = FALSE
                          )

# Tidy-up: remove the first two columns (index) and first row (old column names)
consensus_all <- consensus_all[2:8,2:4]

# Add new class information (just want to visualise it differently)
consensus_all$forest_nonforest = c("Non-Forest", "Non-Forest", "Non-Forest",
                                   "Uncertain", "Forest", "Forest", "Forest")
consensus_all$consensus = c("Full", "High", "Low", "None", 
                            "Low", "High", "Full")


# Convert columns to numeric
consensus_all$total_area_ha <- as.numeric(consensus_all$total_area_ha)
consensus_all$coverage_per <- as.numeric(consensus_all$coverage_per)


```


Note the colours here are selected to be used for the consensus map as well. I used a colour-blind safe palette (https://color.adobe.com/create/color-accessibility) with aim to highlight non-consensus areas compared to consensus forest. 


```{r con_bar}

# Create the bar chart for the consensus map results
ggplot(data=consensus_all, aes(x = interaction(consensus, class), 
                               y = total_area_ha/1000000,
                               fill = class)) +
  geom_bar(stat="identity",
           colour="black",
           width=0.5) +
  scale_fill_manual(values=c("#FFFFFF", "#DCDCDC", "#B4B6BB", "#F1AB4A",
                             "#EFF171", "#ABE071", "#0F5726")) +
  coord_cartesian(xlim = c(0.5, 7.5), ylim = c(0, 3.5),  expand=FALSE, clip="off") +
  scale_y_continuous(labels = label_number(accuracy = 0.1),
                     breaks = c(0, 0.5, 1.0, 1.5, 2.0, 2.5, 3.0, 3.5),
                     ) +
  labs(y="Total Area within Germany Natura 2000 Areas \n(millions ha)\n") +
  annotate(geom = "text", 
           x = seq_len(nrow(consensus_all)), 
           y = -0.1, 
           label = consensus_all$consensus, 
           size = 4,
           family = "serif") +
  annotate(geom = "text", 
           x = c(2, 4, 6), 
           y = 3.25, 
           label = unique(consensus_all$forest_nonforest), 
           size = 4,
           family = "serif") +
    annotate(geom = "text", 
           x = 4, 
           y = -0.3, 
           label = "\nDegree of Consensus", 
           size = 4.5,
           family = "serif") +
  geom_vline(xintercept = 3.5, 
             colour = "#676767", 
             linetype = 'dashed'
             ) +
    geom_vline(xintercept = 4.5, 
             colour = "#676767", 
             linetype = 'dashed'
             ) +
  theme(plot.margin = unit(c(1, 1, 3, 1), "lines"),
        panel.grid.major.x = element_blank(),
        panel.background = element_blank(),
        axis.line = element_line(colour = "black"),
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        text = element_text(family="serif"),
        legend.position = "none",
        axis.text = element_text(size=12),
        axis.title = element_text(size=13)
        )

```



```{r con_bar_save}

# Once happy with the outputs, save them!
# Note this will output whatever plot was run last!
ggsave("outputs/figures/consensus_bar_chart.png",
       width=7,
       height=4
       )

```



```{r temp}

# Just (temporarily) saving my old colour scheme so I have them somewhere
oldcolours <- c("white", "#5985de", "#9ce6f1", "#f1ab4a",
                             "#eff171", "#8acc62", "#1a9641")
```


 Ross also suggested creating a tree map with the consensus map data. 
 
https://www.data-to-viz.com/graph/treemap.html
https://r-graph-gallery.com/treemap.html


```{r con_treemap}

# Add grouping variable name
consensus_all$treemap_group = c("Non-Forest: Full Consensus", "Non-Forest: High Consensus",
                                "Non-Forest: Low Consensus", "Uncertain: No Consensus", 
                                "Forest: Low Consensus", "Forest: High Consensus", 
                                "Forest: Full Consensus")

# Plot tree map
treemap(consensus_all,
        index= "treemap_group",
        vSize="total_area_ha",
        type="index",
        title = "",
        palette = c("#0F5726", "#ABE071", "#EFF171", "#FFFFFF", "#DCDCDC", "#B4B6BB",
                    "#F1AB4A")
        )

```

```{r con_treemap_class1}

# Adjust how many digits to display
options(digits=9)

# Read in CSV with adjusted column names
class1_fnf_combo <- read_csv("outputs/treemap_class1_fnfcombo_natura_stats.csv", 
                             col_names = c("index", 
                                           "fnf_combo", 
                                           "forest_pixels",
                                           "forest_area_ha"
                                           ),
                             show_col_types = FALSE
                             )

# Tidy-up: remove the first column (index) and first row (old column names)
class1_fnf_combo <- class1_fnf_combo[2:7,2:4]

# Convert columns to numeric
class1_fnf_combo$forest_pixels <- as.numeric(class1_fnf_combo$forest_pixels)
class1_fnf_combo$forest_area_ha <- as.numeric(class1_fnf_combo$forest_area_ha)

# Plot tree map
treemap(class1_fnf_combo,
        index= "fnf_combo",
        vSize="forest_area_ha",
        type="index",
        title = "Class 1 Breakdown: Which maps indicate forest presence, when all others indicate absence?",
        fontsize.title = 11
        )

```


The ESA map is most likely to estimate forest presence in areas where the other maps estimate non-forest.


```{r con_treemap_class2}

# Adjust how many digits to display
options(digits=9)

# Read in CSV with adjusted column names
class2_fnf_combo <- read_csv("outputs/treemap_class2_fnfcombo_natura_stats.csv", 
                             col_names = c("index", 
                                           "fnf_combo", 
                                           "forest_pixels",
                                           "forest_area_ha"
                                           ),
                             show_col_types = FALSE
                             )

# Tidy-up: remove the first column (index) and first row (old column names)
class2_fnf_combo <- class2_fnf_combo[2:16,2:4]

# Convert columns to numeric
class2_fnf_combo$forest_pixels <- as.numeric(class2_fnf_combo$forest_pixels)
class2_fnf_combo$forest_area_ha <- as.numeric(class2_fnf_combo$forest_area_ha)

# Plot tree map
treemap(class2_fnf_combo,
        index= "fnf_combo",
        vSize="forest_area_ha",
        type="index",
        title = "Class 2 Breakdown: Which 2 maps indicate forest presence, when 4 others indicate absence?",
        fontsize.title = 11
        )

```


```{r con_treemap_class3}

# Adjust how many digits to display
options(digits=9)

# Read in CSV with adjusted column names
class3_fnf_combo <- read_csv("outputs/treemap_class3_fnfcombo_natura_stats.csv", 
                             col_names = c("index", 
                                           "fnf_combo", 
                                           "forest_pixels",
                                           "forest_area_ha"
                                           ),
                             show_col_types = FALSE
                             )

# Tidy-up: remove the first column (index) and first row (old column names)
class3_fnf_combo <- class3_fnf_combo[2:16,2:4]

# Convert columns to numeric
class3_fnf_combo$forest_pixels <- as.numeric(class3_fnf_combo$forest_pixels)
class3_fnf_combo$forest_area_ha <- as.numeric(class3_fnf_combo$forest_area_ha)

# Plot tree map
treemap(class3_fnf_combo,
        index= "fnf_combo",
        vSize="forest_area_ha",
        type="index",
        title = "Class 3 Breakdown: Which 3 maps indicate forest presence, when 3 others indicate absence?",
        fontsize.title = 11
        )

```
